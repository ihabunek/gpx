{% extends "templates/base.html" %}

{% block content %}
  <h1>{{ name }}</h1>

  <h3>Metadata</h3>

  Time: {{ metadata.time|date:fullDateTime }}<br />
  Link: {{ metadata.link }}

  <h3>Map</h3>

  <div id="track-map"></div>

  <h3>Elevation plot</h3>

  <div id="elevation-chart"></div>

  <h3 id="stats">Stats</h3>

  <h4>Totals</h4>

  Distance: {{ stats.total.distance|distance }}<br />
  Duration: {{ stats.total.duration|duration }}

  <h4>Speeds</h4>

  Max: {{ stats.speed.max|speed }}<br />
  Avg: {{ stats.speed.avg|speed }}

  <h4>Elevation</h4>

  Gain: {{ stats.elevation.gain|double-format:0 }} m<br />
  Loss: {{ stats.elevation.loss|double-format:0 }} m<br />
  Diff: {{ stats.elevation.diff|double-format:0 }} m
{% endblock content %}

{% block head %}
  <link rel="stylesheet" href="/assets/leaflet/leaflet.css" />
  <style type="text/css">
    #track-map {
      height: 400px;
    }
    #elevation-chart {
      height: 400px;
      width: 100%;
    }
  </style>
{% endblock head %}

{% block script %}
  <script src="/assets/leaflet/leaflet.js"></script>
  <script src="/assets/highcharts/highcharts.js"></script>

  <script type="text/javascript">
    var chart;

    function zip(arrays) {
      return arrays[0].map(function(_,i){
        return arrays.map(function(array){return array[i]})
      });
    }

    function elevationChart(targetID, times, elevations) {
      var target = document.getElementById(targetID);

      var dates = times.map(function (time) {
        return Date.parse(time);
      })

      var data = zip([dates, elevations]);

      chart = new Highcharts.Chart({
        chart: {
            renderTo: target,
            zoomType: 'x'
        },
        title: {
            text: 'Elevation'
        },
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            title: {
                text: 'Elevation'
            }
        },
        legend: {
            enabled: false
        },
        series: [{
            name: 'elevation',
            data: data
        }]
      });
    }

    document.addEventListener("DOMContentLoaded", function(event) {
      var segments = [{% for s in segment %}
        [{% for point in s.points %}[{{ point.lat }},{{ point.lon }}],{% endfor %}],
      {% endfor %}];

      var waypoints = [
        {% for wp in waypoint %}{ "lat": {{ wp.lat }}, "lon": {{ wp.lon }}, "name": "{{ wp.name }}" },
        {% endfor %}];

      var elevations = [{% for s in segment %}{% for point in s.points %}{{ point.ele }},{% endfor %}{% endfor %}];
      var times = [{% for s in segment %}{% for point in s.points %}"{{ point.time }}",{% endfor %}{% endfor %}];

      var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
      });

      var cyclemap = L.tileLayer('http://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>,' +
                     '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });

      var outdoors = L.tileLayer('https://[abc].tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', {
         attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>,' +
                      '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      })

      var defaultLayer = osm;

      var layers = {
        "OpenStreetMap": osm,
        "OpenCycleMap": cyclemap,
        "Outdoors": outdoors,
      };

      var trackMap = L.map('track-map').addLayer(defaultLayer);

      // Draw the line segments
      var points = segments.map(function (segment) {
        return segment.map(function (point) {
          return L.latLng(point[0], point[1]);
        })
      })

      var line = L.multiPolyline(points).addTo(trackMap);
      trackMap.fitBounds(line.getBounds());

      // Add waypoint markers
      waypoints.map(function(wp) {
        L.marker([wp.lat, wp.lon])
          .bindPopup(wp.name)
          .addTo(trackMap);
      });

      // Add layer control
      L.control.layers(layers).addTo(trackMap);

      elevationChart('elevation-chart', times, elevations);
    });
  </script>
{% endblock script %}
