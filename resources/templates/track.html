{% extends "templates/base.html" %}

{% block content %}
<h1>{{ name }}</h1>

<h3>Metadata</h3>

Time: {{ metadata.time|date:fullDateTime }}<br />
Link: {{ metadata.link }}

<h3>Map</h3>

<div id="track-map"></div>

<h3>Totals</h3>

Distance {{ stats.total.distance|double-format:1 }} m<br />
Duration {{ stats.total.duration|double-format:0 }} s

<h3>Speeds</h3>

Max: {{ stats.speed.max|double-format:2 }} km/h<br />
Avg: {{ stats.speed.avg|double-format:2 }} km/h

<h3>Elevation</h3>

Gain: {{ stats.elevation.gain|double-format:1 }} m<br />
Loss: {{ stats.elevation.loss|double-format:1 }} m<br />
Diff: {{ stats.elevation.diff|double-format:1 }} m
{% endblock content %}

{% block head %}
<style type="text/css">
    #track-map {
        height: 600px;
    }
</style>
{% endblock head %}

{% block script %}
<script type="text/javascript">

    document.addEventListener("DOMContentLoaded", function(event) {
        var segments = [{% for s in segment %}
            [{% for point in s.path %}[{{ point.lat }},{{ point.lon }}],{% endfor %}]
        {% endfor %}];

        var waypoints = [
            {% for wp in waypoints %}{ "lat": {{ wp.lat }}, "lon": {{ wp.lon }}, "name": "{{ wp.name }}" },{% endfor %}
        ];

        var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        });

        var cyclemap = L.tileLayer('http://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>,' +
                         '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        var outdoors = L.tileLayer('https://[abc].tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', {
           attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>,' +
                        '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        })

        var defaultLayer = osm;

        var layers = {
            "OpenStreetMap": osm,
            "OpenCycleMap": cyclemap,
            "Outdoors": outdoors,
        };

        var trackMap = L.map('track-map').addLayer(defaultLayer);

        // Draw the line segments
        var points = segments.map(function (segment) {
            return segment.map(function (point) {
                return L.latLng(point[0], point[1]);
            })
        })

        var line = L.multiPolyline(points).addTo(trackMap);
        trackMap.fitBounds(line.getBounds());

        // Add waypoint markers
        waypoints.map(function(wp) {
            L.marker([wp.lat, wp.lon])
                .bindPopup(wp.name)
                .addTo(trackMap);
        });

        // Add layer control
        L.control.layers(layers).addTo(trackMap);
    });
</script>
{% endblock script %}
